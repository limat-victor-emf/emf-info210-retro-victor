<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Retro Gaming – SWA + Container Apps</title>
    <style>
        body {
            font-family: system-ui, Arial;
            margin: 20px;
        }

        #wrap {
            max-width: 1000px;
            margin: 0 auto;
        }

        #gamebox {
            width: 100%;
            height: 600px;
            max-width: 100%;
            border: 1px solid #ccc;
        }

        select,
        button {
            padding: 8px;
            font-size: 14px;
        }

        .row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        small {
            color: #555;
        }
    </style>
</head>

<body>
    <div id="wrap">
        <h1>Retro Gaming (Azure SWA + Container Apps)</h1>
        <p><small>Utilisez uniquement des ROM homebrew / open-source / public domain.</small></p>

        <div class="row">
            <label for="games">Jeu :</label>
            <select id="games"></select>
            <button id="play">Jouer</button>
            <span id="status"></span>
        </div>

        <div id="gamebox">
            <div id="game"></div>
        </div>
    </div>

    <script>
        const statusEl = document.getElementById("status");
        const gamesEl = document.getElementById("games");
        const playBtn = document.getElementById("play");

        async function loadGames() {
            statusEl.textContent = "Chargement des jeux...";
            const res = await fetch("/api/games"); // <- proxy SWA -> Container App
            const data = await res.json();

            gamesEl.innerHTML = "";
            for (const g of data.games || []) {
                const opt = document.createElement("option");
                opt.value = g.rom;     // ex: /api/roms/demo.nes
                opt.textContent = g.title;
                gamesEl.appendChild(opt);
            }
            statusEl.textContent = (data.games?.length ? "OK" : "Aucun jeu trouvé");
        }

        function startEmu(romUrl) {
            // Nettoyage si relance
            document.getElementById("game").innerHTML = "";

            // Configuration EmulatorJS (exemple NES)
            // Doc + exemples: :contentReference[oaicite:9]{index=9}
            window.EJS_player = "#game";
            window.EJS_core = "nestopia";       // NES
            window.EJS_gameUrl = romUrl;        // /api/roms/xxx.nes (proxy via SWA)
            window.EJS_pathtodata = "https://www.emulatorjs.com/data/"; // assets emulator

            const s = document.createElement("script");
            s.src = "https://www.emulatorjs.com/loader.js";
            document.body.appendChild(s);
        }

        playBtn.addEventListener("click", () => {
            const romUrl = gamesEl.value;
            if (!romUrl) return;
            statusEl.textContent = "Démarrage du jeu...";
            startEmu(romUrl);
        });

        loadGames().catch(err => {
            console.error(err);
            statusEl.textContent = "Erreur chargement (API /api/games)";
        });
    </script>
</body>

</html>